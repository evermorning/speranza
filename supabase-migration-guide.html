<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 결제 테이블 마이그레이션</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
        }
        h1 {
            color: #3ecf8e;
            border-bottom: 2px solid #3ecf8e;
            padding-bottom: 10px;
        }
        h2 {
            color: #48b9ff;
            margin-top: 30px;
        }
        .step {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3ecf8e;
            border-radius: 4px;
        }
        .sql-code {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 20px;
            overflow-x: auto;
            position: relative;
        }
        .sql-code pre {
            margin: 0;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3ecf8e;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .copy-btn:hover {
            background: #2eaf7e;
        }
        .success {
            background: #1e4d2b;
            color: #3ecf8e;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background: #4d3a1e;
            color: #ffb84d;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        a {
            color: #48b9ff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .table-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .table-name {
            font-weight: bold;
            color: #3ecf8e;
            font-size: 16px;
        }
        .table-desc {
            color: #aaa;
            font-size: 13px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Supabase 결제 테이블 마이그레이션</h1>
        
        <div class="warning">
            ⚠️ <strong>중요:</strong> 이 마이그레이션은 2단계로 나누어 실행해야 합니다!<br>
            1단계: users 테이블 생성<br>
            2단계: 결제 관련 테이블 생성 (users 테이블 참조)
        </div>

        <h2>📋 1단계: users 테이블 생성</h2>
        
        <div class="step">
            <strong>1-1:</strong> Supabase Dashboard 접속<br>
            👉 <a href="https://app.supabase.com/project/zxodavgsdtpnbmqojtnh/sql/new" target="_blank">
                SQL Editor 바로가기
            </a>
        </div>

        <div class="step">
            <strong>1-2:</strong> 아래 <strong>"SQL 1단계"</strong>를 복사
        </div>

        <div class="step">
            <strong>1-3:</strong> SQL Editor에 붙여넣고 <strong>Run</strong> 클릭
        </div>

        <div class="step">
            <strong>1-4:</strong> 성공 메시지 확인 후 <strong>"SQL 2단계"</strong> 실행
        </div>

        <h2>📊 생성되는 테이블 (6개)</h2>
        
        <div class="table-list">
            <div class="table-item">
                <div class="table-name">💳 payments</div>
                <div class="table-desc">모든 결제 내역 (단건 + 정기)</div>
            </div>
            <div class="table-item">
                <div class="table-name">🔑 billing_keys</div>
                <div class="table-desc">정기결제 빌링키</div>
            </div>
            <div class="table-item">
                <div class="table-name">📦 subscription_plans</div>
                <div class="table-desc">구독 플랜 (무료/베이직/프로)</div>
            </div>
            <div class="table-item">
                <div class="table-name">👤 user_subscriptions</div>
                <div class="table-desc">사용자 구독 정보</div>
            </div>
            <div class="table-item">
                <div class="table-name">💰 user_payment_info</div>
                <div class="table-desc">사용자 결제 정보</div>
            </div>
            <div class="table-item">
                <div class="table-name">↩️ refunds</div>
                <div class="table-desc">환불 내역</div>
            </div>
        </div>

        <h2>📝 SQL 1단계: users 테이블</h2>
        
        <div class="sql-code">
            <button class="copy-btn" onclick="copySQL1()">📋 Copy SQL 1단계</button>
            <pre id="sqlCode1">-- ========================================
-- 사용자 테이블 생성 (먼저 실행!)
-- ========================================

CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) NOT NULL UNIQUE,
  name VARCHAR(100),
  password VARCHAR(255) NOT NULL,
  provider VARCHAR(50) DEFAULT 'credentials',
  image TEXT,
  email_verified TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();</pre>
        </div>

        <h2>📝 SQL 2단계: 결제 테이블</h2>
        
        <div class="sql-code">
            <button class="copy-btn" onclick="copySQL2()">📋 Copy SQL 2단계</button>
            <pre id="sqlCode2">-- ========================================
-- 결제 관련 테이블 생성 (단건결제 + 정기결제)
-- ========================================

-- 1️⃣ 구독 플랜 테이블
CREATE TABLE IF NOT EXISTS subscription_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL UNIQUE,
  display_name VARCHAR(200) NOT NULL,
  description TEXT,
  price INTEGER NOT NULL DEFAULT 0,
  currency VARCHAR(3) NOT NULL DEFAULT 'KRW',
  interval VARCHAR(20) NOT NULL DEFAULT 'month',
  interval_count INTEGER NOT NULL DEFAULT 1,
  features JSONB NOT NULL DEFAULT '{}',
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 2️⃣ 사용자 구독 테이블 (정기결제)
CREATE TABLE IF NOT EXISTS user_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  plan_id UUID NOT NULL REFERENCES subscription_plans(id) ON DELETE RESTRICT,
  billing_key_id UUID,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ,
  next_billing_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 3️⃣ 결제 테이블 (단건결제 + 정기결제 모두 저장)
CREATE TABLE IF NOT EXISTS payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES user_subscriptions(id) ON DELETE SET NULL,
  payment_key VARCHAR(200) NOT NULL UNIQUE,
  order_id VARCHAR(200) NOT NULL UNIQUE,
  order_name VARCHAR(200) NOT NULL,
  amount INTEGER NOT NULL,
  currency VARCHAR(3) NOT NULL DEFAULT 'KRW',
  payment_method VARCHAR(50),
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  payment_type VARCHAR(20) NOT NULL DEFAULT 'one_time',
  approved_at TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ,
  failed_at TIMESTAMPTZ,
  receipt_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 4️⃣ 빌링키 테이블 (정기결제용)
CREATE TABLE IF NOT EXISTS billing_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  billing_key VARCHAR(200) NOT NULL UNIQUE,
  customer_key VARCHAR(200) NOT NULL,
  method VARCHAR(50),
  card_info JSONB,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 5️⃣ 사용자 결제 정보 테이블
CREATE TABLE IF NOT EXISTS user_payment_info (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  customer_key VARCHAR(200) NOT NULL UNIQUE,
  default_payment_method VARCHAR(50),
  billing_address JSONB,
  tax_id VARCHAR(50),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 6️⃣ 환불 테이블
CREATE TABLE IF NOT EXISTS refunds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  payment_id UUID NOT NULL REFERENCES payments(id) ON DELETE CASCADE,
  refund_key VARCHAR(200) NOT NULL UNIQUE,
  amount INTEGER NOT NULL,
  reason TEXT,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  processed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 📊 인덱스 생성 (성능 최적화)
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_status ON user_subscriptions(status);
CREATE INDEX IF NOT EXISTS idx_payments_user_id ON payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_payment_key ON payments(payment_key);
CREATE INDEX IF NOT EXISTS idx_payments_order_id ON payments(order_id);
CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
CREATE INDEX IF NOT EXISTS idx_billing_keys_user_id ON billing_keys(user_id);
CREATE INDEX IF NOT EXISTS idx_billing_keys_billing_key ON billing_keys(billing_key);
CREATE INDEX IF NOT EXISTS idx_billing_keys_status ON billing_keys(status);
CREATE INDEX IF NOT EXISTS idx_user_payment_info_user_id ON user_payment_info(user_id);
CREATE INDEX IF NOT EXISTS idx_refunds_payment_id ON refunds(payment_id);

-- 🎁 기본 플랜 데이터 삽입
INSERT INTO subscription_plans (name, display_name, description, price, features)
VALUES (
  'free',
  '무료 플랜',
  '기본 기능을 사용할 수 있는 무료 플랜입니다.',
  0,
  '{"limits": {"daily_searches": 10, "trend_reports": 5}}'::JSONB
) ON CONFLICT (name) DO NOTHING;

INSERT INTO subscription_plans (name, display_name, description, price, features)
VALUES (
  'basic',
  '베이직 플랜',
  '더 많은 기능을 사용할 수 있는 베이직 플랜입니다.',
  9900,
  '{"limits": {"daily_searches": 100, "trend_reports": 50}}'::JSONB
) ON CONFLICT (name) DO NOTHING;

INSERT INTO subscription_plans (name, display_name, description, price, features)
VALUES (
  'pro',
  '프로 플랜',
  '무제한으로 모든 기능을 사용할 수 있는 프로 플랜입니다.',
  29900,
  '{"limits": {"daily_searches": -1, "trend_reports": -1}}'::JSONB
) ON CONFLICT (name) DO NOTHING;</pre>
        </div>

        <div class="success">
            ✅ <strong>성공 확인:</strong> Table Editor에서 6개 테이블과 3개 플랜 데이터를 확인하세요!
        </div>

        <h2>🔗 빠른 링크</h2>
        <div class="step">
            <a href="https://app.supabase.com/project/zxodavgsdtpnbmqojtnh/editor" target="_blank">
                🗄️ SQL Editor 바로가기
            </a>
        </div>
        <div class="step">
            <a href="https://app.supabase.com/project/zxodavgsdtpnbmqojtnh/editor" target="_blank">
                📊 Table Editor 바로가기
            </a>
        </div>
    </div>

    <script>
        function copySQL1() {
            const sqlCode = document.getElementById('sqlCode1').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('✅ SQL 1단계가 클립보드에 복사되었습니다!\n\nSupabase SQL Editor에 붙여넣고 Run을 클릭하세요.');
            });
        }
        
        function copySQL2() {
            const sqlCode = document.getElementById('sqlCode2').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('✅ SQL 2단계가 클립보드에 복사되었습니다!\n\nSQL 1단계 실행 후 이 SQL을 붙여넣고 Run을 클릭하세요.');
            });
        }
    </script>
</body>
</html>
